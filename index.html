<!DOCTYPE html>
<html>
  <head>
    <script>

     function fetchAndInstantiate(url, importObject = {}) {
       return fetch(url)
	 .then(response => response.arrayBuffer())
	 .then(bytes => WebAssembly.instantiate(bytes, importObject))
	 .then(results => results.instance);
     }
     
     function copyCStr(module, ptr) {
       let orig_ptr = ptr;
       const collectCString = function* () {
         let memory = new Uint8Array(module.memory.buffer);
         while (memory[ptr] !== 0) {
           if (memory[ptr] === undefined) { throw new Error("Tried to read undef mem") }
           yield memory[ptr]
           ptr += 1
         }
       }

       const buffer_as_u8 = new Uint8Array(collectCString())
       const utf8Decoder = new TextDecoder("UTF-8");
       const buffer_as_utf8 = utf8Decoder.decode(buffer_as_u8);
       module.dealloc_str(orig_ptr);
       return buffer_as_utf8
     }

     function getStr(module, ptr, len) {
       const getData = function* (ptr, len) {
         let memory = new Uint8Array(module.memory.buffer);
         for (let index = 0; index < len; index++) {
           if (memory[ptr] === undefined) { throw new Error(`Tried to read undef mem at ${ptr}`) }
           yield memory[ptr + index]
         }
       }

       const buffer_as_u8 = new Uint8Array(getData(ptr / 8, len / 8));
       const utf8Decoder = new TextDecoder("UTF-8");
       const buffer_as_utf8 = utf8Decoder.decode(buffer_as_u8);
       return buffer_as_utf8;
     }

     function newString(module, str) {
       const utf8Encoder = new TextEncoder("UTF-8");
       let string_buffer = utf8Encoder.encode(str)
       let len = string_buffer.length
       let ptr = module.alloc(len + 1)

       let memory = new Uint8Array(module.memory.buffer);
       for (i = 0; i < len; i++) {
         memory[ptr + i] = string_buffer[i]
       }

       memory[ptr + len] = 0;

       return ptr
     }

     request = new XMLHttpRequest();
     request.open('GET', 'japonic_app.gc.wasm');
     request.responseType = 'arraybuffer';
     request.send();

     var exports;
     var romaji_to_hiragana;
     var romaji_to_hiragana_safe;
     
     request.onload = function() {
       var bytes = request.response;
       WebAssembly.instantiate(bytes).then(results => {
         const instance = results.instance;
         exports = instance.exports;

         romaji_to_hiragana = s => {
           let outptr = exports.romaji_to_hiragana(newString(exports, s));
           return copyCStr(exports, outptr);
         };

         romaji_to_hiragana_safe = s => {
           let outptr = exports.romaji_to_hiragana_safe(newString(exports, s));
           return copyCStr(exports, outptr);
         };
         console.log(romaji_to_hiragana('arigatou'));

       });
     };

     function convert(event) {
       console.log(event.value);
       document.getElementById("result").innerHTML = romaji_to_hiragana(event.value);
     }

     function overwrite(event) {
       // const start = event.selectionStart;
       // const end = event.selectionEnd;
       
       event.value = romaji_to_hiragana_safe(event.value);

       // restore from variables...
       // event.setSelectionRange(start, end);
     }     
    </script>
  </head>
  <body>
    <p id="result"></p>
    <input id="box" type="text" onkeydown="convert(this)" onkeyup="convert(this)"></input>
  </break>
  <input id="overwrite" type="text"  onkeyup="overwrite(this)"></input>

  <style>
   #result, #box, #overwrite {
     font-size: 2em;
     color: black;
   }
  </style>
  </body>
</html>
